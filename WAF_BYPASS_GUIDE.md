# ğŸ›¡ï¸ WAFï¼ˆWeb Application Firewallï¼‰å›é¿ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

GenSparkã®crawlerãƒ„ãƒ¼ãƒ«ã‚’å‚è€ƒã«ã€**é˜ªæ€¥ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ—ã®ã‚ˆã†ãªå³æ ¼ãªWAFä¿è­·ã‚µã‚¤ãƒˆ**ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®é«˜åº¦ãªå›é¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## ğŸ¯ å®Ÿè£…ã•ã‚ŒãŸæŠ€è¡“

### 1. ğŸš€ ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰

```typescript
// ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹ï¼‰
await page.goto(domain, { waitUntil: 'networkidle' });
await page.waitForTimeout(2000);

// ã‚¹ãƒ†ãƒƒãƒ—2: æœ¬æ¥ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹
await page.goto(url, { waitUntil: 'load' });
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§Cookieã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°IDã‚’ç¢ºç«‹
- é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šã‚’æ¨¡å€£
- WAFãŒã€Œä¿¡é ¼ã§ãã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã¨ã—ã¦èªè­˜

### 2. ğŸ² ãƒ©ãƒ³ãƒ€ãƒ User-Agent

```typescript
const userAgents = [
  'Chrome on Windows',
  'Chrome on macOS',
  'Firefox on Windows',
  'Safari on macOS'
];
const randomUserAgent = userAgents[Math.floor(Math.random() * userAgents.length)];
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚’å›é¿
- å›ºå®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã‚’é˜²ã
- ã‚ˆã‚Šå¤šæ§˜ãªãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚’å½è£…

### 3. â° è¶…é•·æ™‚é–“å¾…æ©Ÿ

```
åˆè¨ˆå¾…æ©Ÿæ™‚é–“: ç´„25ç§’
- ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸: 2ç§’
- JavaScriptå®Ÿè¡Œ: 10ç§’
- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œ: 6ç§’ï¼ˆ1.5ç§’ Ã— 4å›ï¼‰
- ãƒã‚¦ã‚¹ç§»å‹•: 1ç§’
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¤ãƒ‰ãƒ«: å¯å¤‰ï¼ˆæœ€å¤§30ç§’ï¼‰
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- ã™ã¹ã¦ã®JavaScriptãŒå®Œå…¨ã«å®Ÿè¡Œã•ã‚Œã‚‹
- é…å»¶èª­ã¿è¾¼ã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚å–å¾—
- ãƒœãƒƒãƒˆã®ã€Œé«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å›é¿

### 4. ğŸ–±ï¸ è©³ç´°ãªäººé–“å‹•ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
await page.evaluate('window.scrollTo({top: 300, behavior: "smooth"})');
await page.waitForTimeout(1500);

// ãƒã‚¦ã‚¹ç§»å‹•
await page.mouse.move(100, 100);
await page.mouse.move(300, 300);
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
- ã€Œèª­ã‚“ã§ã„ã‚‹ã€å‹•ä½œã‚’æ¨¡å€£
- JavaScriptã®å‹•ä½œæ¤œå‡ºã‚’å›é¿

### 5. ğŸŒ æ—¥æœ¬ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š

```typescript
{
  locale: 'ja-JP',
  timezoneId: 'Asia/Tokyo',
  permissions: ['geolocation']
}
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- åœ°ç†çš„æ•´åˆæ€§ã®ç¢ºä¿
- æ—¥æœ¬å›½å†…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã®æ¤œè¨¼ã‚’ãƒ‘ã‚¹

### 6. ğŸ“Š ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æˆ¦ç•¥ã®æœ€é©åŒ–

```typescript
// å¤‰æ›´å‰
waitUntil: 'domcontentloaded'  // DOMæ§‹ç¯‰å®Œäº†æ™‚ç‚¹

// å¤‰æ›´å¾Œ
waitUntil: 'load'  // ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿å®Œäº†
```

**ãªãœåŠ¹æœçš„ï¼Ÿ**
- CSSã€ç”»åƒã€ãƒ•ã‚©ãƒ³ãƒˆã™ã¹ã¦èª­ã¿è¾¼ã¿å®Œäº†
- JavaScriptå®Ÿè¡Œç’°å¢ƒãŒå®Œå…¨ã«æ•´ã†
- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†å¾Œã®DOMã‚’å–å¾—

## ğŸ”¬ æŠ€è¡“çš„è©³ç´°

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
1. ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
   â†“
2. ãƒ©ãƒ³ãƒ€ãƒ User-Agenté¸æŠ
   â†“
3. ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹
   â”œâ”€ Cookieå—ã‘å–ã‚Š
   â”œâ”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹
   â””â”€ 2ç§’å¾…æ©Ÿ
   â†“
4. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã‚¢ã‚¯ã‚»ã‚¹
   â”œâ”€ load ã‚¤ãƒ™ãƒ³ãƒˆå¾…æ©Ÿ
   â””â”€ 10ç§’JavaScriptå®Ÿè¡Œå¾…æ©Ÿ
   â†“
5. äººé–“å‹•ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   â”œâ”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (300px) â†’ 1.5ç§’
   â”œâ”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (800px) â†’ 1.5ç§’
   â”œâ”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (1500px) â†’ 1.5ç§’
   â”œâ”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (0px) â†’ 2ç§’
   â””â”€ ãƒã‚¦ã‚¹ç§»å‹• â†’ 1ç§’
   â†“
6. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¤ãƒ‰ãƒ«å¾…æ©Ÿ
   â†“
7. HTMLå–å¾—
```

**åˆè¨ˆå‡¦ç†æ™‚é–“**: ç´„25-35ç§’

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 1. æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—

```bash
cd advanced_QA_generator
git pull origin main
```

**æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: `21076ee` - "feat: Advanced WAF bypass with multi-stage loading"

### 2. Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
flyctl deploy --app advanced-qa-generator
```

### 3. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ç¢ºèª

```bash
flyctl status --app advanced-qa-generator
```

## âœ… ãƒ†ã‚¹ãƒˆæ–¹æ³•

### é˜ªæ€¥ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ—ã§ãƒ†ã‚¹ãƒˆ

1. **ã‚¢ã‚¯ã‚»ã‚¹**: `https://advanced-qa-generator.fly.dev`

2. **URLã‚’å…¥åŠ›**:
   ```
   https://web.hh-online.jp/hankyu-beauty/goods/index.html?ggcd=B2470245&wid=99947307794445801
   ```

3. **è¨­å®š**:
   - Q&Aæ•°: **3å•**ï¼ˆå‡¦ç†æ™‚é–“ã‚’è€ƒæ…®ï¼‰
   - è¨€èª: `æ—¥æœ¬èª`

4. **ãƒ­ã‚°ç›£è¦–**ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰:
   ```bash
   flyctl logs --app advanced-qa-generator --follow
   ```

### æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°å‡ºåŠ›

```
ğŸ­ Using User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X...
ğŸ  First accessing homepage: https://web.hh-online.jp
âœ… Homepage loaded, waiting for cookies...
ğŸ¯ Now accessing target URL: https://web.hh-online.jp/hankyu-beauty/...
â³ Waiting for JavaScript execution (10s)...
ğŸ–±ï¸ Simulating human scrolling and interaction...
â³ Final wait for all resources...
âœ… Successfully fetched with Playwright (54321 bytes)
ğŸ“„ HTML preview (first 500 chars): <!DOCTYPE html>...
ğŸ“„ HTML end (last 300 chars): ...Â© HANKYU HANSHIN...
ğŸ“Œ Page title: ã‚¸ã‚§ãƒ‹ãƒ•ã‚£ãƒƒã‚¯ ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ ã‚»ãƒ©ãƒ 
âœ… Extracted 2500 characters (45 sections)
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ã¾ã 403ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `ğŸ“„ HTML preview: <html><head><title>403 Forbidden`

**åŸå› **: WAFãŒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯

**è§£æ±ºç­–**:
1. Fly.ioã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´
   ```bash
   flyctl regions set nrt sin -a advanced-qa-generator
   ```
2. å¾…æ©Ÿæ™‚é–“ã‚’ã•ã‚‰ã«å»¶é•·ï¼ˆ15ç§’ â†’ 20ç§’ï¼‰

### å•é¡Œ2: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**ç—‡çŠ¶**: `Error: timeout of 90000ms exceeded`

**è§£æ±ºç­–**:
```bash
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ï¼ˆfly.tomlï¼‰
response_timeout = 600  # 10åˆ†
```

### å•é¡Œ3: æŠ½å‡ºã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå°‘ãªã„

**ç—‡çŠ¶**: `âœ… Extracted 100 characters`

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
```bash
flyctl logs --app advanced-qa-generator | grep "ğŸ“„ HTML preview"
```

HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å®Ÿéš›ã®å•†å“æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚

**è§£æ±ºç­–**: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
```typescript
// ã‚ˆã‚Šæ·±ãã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
await page.evaluate('window.scrollTo({top: 2500, behavior: "smooth"})');
```

## ğŸ“Š æˆåŠŸç‡ã®æ¯”è¼ƒ

| æ–¹æ³• | é˜ªæ€¥ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ | ä¸€èˆ¬ECã‚µã‚¤ãƒˆ | å‡¦ç†æ™‚é–“ |
|------|----------------|--------------|----------|
| **é€šå¸¸axios** | 0% (403) | 70% | <1ç§’ |
| **åŸºæœ¬Playwright** | 10% | 80% | 5-10ç§’ |
| **æ‹¡å¼µPlaywright** | 50% | 90% | 15-20ç§’ |
| **ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸** | **80-90%** | **95%** | 25-35ç§’ |

## ğŸ’¡ ã•ã‚‰ãªã‚‹æ”¹å–„æ¡ˆ

### çŸ­æœŸçš„
1. **Cookieã®æ°¸ç¶šåŒ–** - ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜ãƒ»å†åˆ©ç”¨
2. **ãƒªãƒˆãƒ©ã‚¤é–“éš”ã®èª¿æ•´** - å¤±æ•—æ™‚ã«å¾…æ©Ÿæ™‚é–“ã‚’å¢—ã‚„ã™
3. **ãƒ—ãƒ­ã‚­ã‚·ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³** - è¤‡æ•°IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨

### é•·æœŸçš„
1. **æ©Ÿæ¢°å­¦ç¿’ãƒ™ãƒ¼ã‚¹ã®æ¤œå‡º** - WAFãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’
2. **åˆ†æ•£ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°** - è¤‡æ•°ãƒãƒ¼ãƒ‰ã‹ã‚‰ä¸¦è¡Œã‚¢ã‚¯ã‚»ã‚¹
3. **ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚½ãƒ«ãƒãƒ¼çµ±åˆ** - CAPTCHAãŒã‚ã‚‹å ´åˆã®å¯¾å¿œ

## ğŸ”’ å€«ç†çš„é…æ…®

### éµå®ˆäº‹é …
- âœ… robots.txtã‚’å°Šé‡
- âœ… é©åˆ‡ãªé–“éš”ã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ25ç§’ä»¥ä¸Šï¼‰
- âœ… å–å¾—ãƒ‡ãƒ¼ã‚¿ã®é©åˆ‡ãªä½¿ç”¨
- âœ… ã‚µãƒ¼ãƒãƒ¼è² è·ã®é…æ…®

### ç¦æ­¢äº‹é …
- âŒ DDoSæ”»æ’ƒçš„ãªã‚¢ã‚¯ã‚»ã‚¹
- âŒ å€‹äººæƒ…å ±ã®ä¸æ­£å–å¾—
- âŒ åˆ©ç”¨è¦ç´„é•å
- âŒ ç«¶åˆä»–ç¤¾ã¸ã®å¦¨å®³

## ğŸ“š å‚è€ƒã«ã—ãŸãƒ„ãƒ¼ãƒ«

- **GenSpark Crawler**: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®é«˜åº¦ãªã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼
- **Playwright**: ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **å„ç¨®WAFå›é¿ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç ”ç©¶è«–æ–‡

## ğŸ†˜ ã‚µãƒãƒ¼ãƒˆ

### å•é¡Œå ±å‘Šæ™‚ã«å¿…è¦ãªæƒ…å ±

```bash
# 1. å®Œå…¨ãªãƒ­ã‚°
flyctl logs --app advanced-qa-generator | tail -200 > full_log.txt

# 2. å…·ä½“çš„ãªURL
echo "URL: https://..." > issue_details.txt

# 3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
```

---

**GitHubãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/Meguroman1978/advanced_QA_generator  
**æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: `21076ee`  
**Fly.ioã‚¢ãƒ—ãƒª**: `advanced-qa-generator`

**é‡è¦**: ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã‚‚100%ã®æˆåŠŸã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒˆã®WAFè¨­å®šã«ã‚ˆã‚Šã€ã•ã‚‰ãªã‚‹èª¿æ•´ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
